mod edge;
use crate::edge::ConnectedComponent;
use delaunator::{triangulate, Point};
use edge::{Edge, FindLabel, Graph, ToGraph};
use pyo3::prelude::*;
use pyo3::wrap_pyfunction;

pub fn autoclust_implementation(points: &[Point]) -> Vec<ConnectedComponent> {
	println!("pp{}", points.len());
	let base_graph = triangulate(points).unwrap().to_graph(points);
	let mut graph_with_filtered_edges = base_graph.filter_edges(&|g: &Graph, e: &Edge| {
		let x = g.is_long(&g.verticies[e.vertex1], &g.verticies[e.vertex2])
			|| g.is_short(&g.verticies[e.vertex1], &g.verticies[e.vertex2]);
		println!("{:?}", x);
		x
	});
	let mut connected_components = graph_with_filtered_edges.to_connected_components();

	graph_with_filtered_edges.restore_edges(&base_graph, &mut connected_components);
	graph_with_filtered_edges.add_edges(&base_graph, &|v1, v2, g| {
		g.is_short(v1, v2)
			&& (!matches!(connected_components.find_label_for(&v1), None)
				^ !matches!(connected_components.find_label_for(&v2), None))
	});
	graph_with_filtered_edges.to_connected_components()
}

#[pyfunction]
pub fn auto_clust(input: Vec<P>) -> PyResult<Vec<Res>> {
	let points: Vec<Point> = input.iter().map(|x| Point { x: x.x, y: x.y }).collect();
	let cc = autoclust_implementation(&points);
	let mut result: Vec<Res> = vec![];
	for i in input.iter().enumerate() {
		result.push(Res {
			x: i.1.x,
			y: i.1.y,
			label: match cc.find_label_for_index(i.0) {
				Some(x) => x + 1,
				None => 0,
			},
		})
	}
	Ok(result)
}

#[pyclass]
#[derive(FromPyObject)]
pub struct P {
	#[pyo3(get, set)]
	pub x: f64,
	#[pyo3(get, set)]
	pub y: f64,
}

#[pymethods]
impl P {
	#[new]
	pub fn new(x: f64, y: f64) -> Self {
		P { x, y }
	}
}

#[pyclass]
#[derive(Debug)]
pub struct Res {
	#[pyo3(get, set)]
	pub x: f64,
	#[pyo3(get, set)]
	pub y: f64,
	#[pyo3(get, set)]
	pub label: usize,
}

#[pymodule]
pub fn autoclust(_: Python, m: &PyModule) -> PyResult<()> {
	m.add_class::<P>()?;
	m.add_class::<Res>()?;
	m.add_wrapped(wrap_pyfunction!(auto_clust))?;
	Ok(())
}

#[cfg(test)]
mod tests {
	use crate::autoclust_implementation;
	use delaunator::Point;
	#[test]
	fn it_works() {}
}

fn main() {
	let points = [
		Point {
			x: 0.4518035340933221,
			y: 0.3024619043075197,
		},
		Point {
			x: 0.459060159600339,
			y: 0.2391556927633164,
		},
		Point {
			x: 0.4285654782025545,
			y: 0.2862930662402794,
		},
		Point {
			x: 0.4843903555522113,
			y: 0.2680002365104355,
		},
		Point {
			x: 0.4884910022536037,
			y: 0.3140034118177222,
		},
		Point {
			x: 0.4882529351089069,
			y: 0.2951807641077181,
		},
		Point {
			x: 0.4261734874134836,
			y: 0.2944082639738861,
		},
		Point {
			x: 0.4923293056354257,
			y: 0.3069760858703706,
		},
		Point {
			x: 0.46581779165516,
			y: 0.236815836248995,
		},
		Point {
			x: 0.4796019914845387,
			y: 0.3027552942405009,
		},
		Point {
			x: 0.4983284308253949,
			y: 0.2599823656141545,
		},
		Point {
			x: 0.4288793576585048,
			y: 0.2854370929258269,
		},
		Point {
			x: 0.48052185259585,
			y: 0.2832297339268187,
		},
		Point {
			x: 0.4222250843200487,
			y: 0.2531889219504343,
		},
		Point {
			x: 0.4743520587629325,
			y: 0.3125824873302201,
		},
		Point {
			x: 0.4683310484963518,
			y: 0.2699832110292296,
		},
		Point {
			x: 0.4154308985062007,
			y: 0.2401660461157853,
		},
		Point {
			x: 0.431579645500734,
			y: 0.3098281516345536,
		},
		Point {
			x: 0.4318412126894631,
			y: 0.273097853197575,
		},
		Point {
			x: 0.4263751922632686,
			y: 0.264188814554247,
		},
		Point {
			x: 0.430280676333087,
			y: 0.2589743983109783,
		},
		Point {
			x: 0.4180836279459548,
			y: 0.2629020895335701,
		},
		Point {
			x: 0.476409303843254,
			y: 0.2741792682127394,
		},
		Point {
			x: 0.4743785428943825,
			y: 0.3030820697891478,
		},
		Point {
			x: 0.448289188185816,
			y: 0.2901135231478844,
		},
		Point {
			x: 0.4799273228947212,
			y: 0.3054967781627992,
		},
		Point {
			x: 0.4436672758097571,
			y: 0.2575125902713314,
		},
		Point {
			x: 0.4911409152020877,
			y: 0.2506012518922546,
		},
		Point {
			x: 0.4309574690244241,
			y: 0.2584396675459483,
		},
		Point {
			x: 0.4501323659662999,
			y: 0.2388171748000313,
		},
		Point {
			x: 0.4692079934781461,
			y: 0.2787844782236187,
		},
		Point {
			x: 0.456456292730939,
			y: 0.2463700623372768,
		},
		Point {
			x: 0.4435594605282038,
			y: 0.2818830707112663,
		},
		Point {
			x: 0.4168813861299014,
			y: 0.2868540770760213,
		},
		Point {
			x: 0.4436612890125752,
			y: 0.3099540124292718,
		},
		Point {
			x: 0.4310589756551059,
			y: 0.2568526140521957,
		},
		Point {
			x: 0.4276820897282312,
			y: 0.3090128671762228,
		},
		Point {
			x: 0.4942609411207308,
			y: 0.2620611006596605,
		},
		Point {
			x: 0.4488396718923833,
			y: 0.2914785821052602,
		},
		Point {
			x: 0.4445721325526933,
			y: 0.2421456884626251,
		},
		Point {
			x: 0.4885090744440025,
			y: 0.2591885893604278,
		},
		Point {
			x: 0.4672012394837263,
			y: 0.3073625778758535,
		},
		Point {
			x: 0.4676207226007715,
			y: 0.3078736392162038,
		},
		Point {
			x: 0.4272796917102048,
			y: 0.2458216199745459,
		},
		Point {
			x: 0.4342539569711171,
			y: 0.271449639908884,
		},
		Point {
			x: 0.483541307027091,
			y: 0.2611727934182027,
		},
		Point {
			x: 0.4545942718327037,
			y: 0.2797912825414541,
		},
		Point {
			x: 0.4303443154373974,
			y: 0.2591739208054554,
		},
		Point {
			x: 0.4748761098873567,
			y: 0.2777512728073361,
		},
		Point {
			x: 0.4974253451041499,
			y: 0.2714454547418542,
		},
		Point {
			x: 0.4918682092816742,
			y: 0.3077017656903979,
		},
		Point {
			x: 0.4603221731023536,
			y: 0.2972751157156896,
		},
		Point {
			x: 0.4736642958820482,
			y: 0.3019381401076393,
		},
		Point {
			x: 0.4790692837164622,
			y: 0.252888118379219,
		},
		Point {
			x: 0.4695041203352911,
			y: 0.2318011951862474,
		},
		Point {
			x: 0.485698621616258,
			y: 0.2829819153244695,
		},
		Point {
			x: 0.4320019595357238,
			y: 0.756130736219407,
		},
		Point {
			x: 0.4217292203229804,
			y: 0.713191324399936,
		},
		Point {
			x: 0.4528182975183777,
			y: 0.7247777875014041,
		},
		Point {
			x: 0.4499197643585051,
			y: 0.7765879026474196,
		},
		Point {
			x: 0.4417050944376334,
			y: 0.7156552485801991,
		},
		Point {
			x: 0.4665691682031211,
			y: 0.7116536622569566,
		},
		Point {
			x: 0.4620458605668778,
			y: 0.7250076998551904,
		},
		Point {
			x: 0.4464574852521222,
			y: 0.771982154010041,
		},
		Point {
			x: 0.4537820405427562,
			y: 0.778499459440259,
		},
		Point {
			x: 0.4674121624587534,
			y: 0.7119234249238495,
		},
		Point {
			x: 0.4613838435241376,
			y: 0.7513407075024536,
		},
		Point {
			x: 0.4571004811331586,
			y: 0.7724840022782123,
		},
		Point {
			x: 0.4673778006713593,
			y: 0.7619283392326696,
		},
		Point {
			x: 0.4350928850210233,
			y: 0.7664842368999172,
		},
		Point {
			x: 0.4674406722871777,
			y: 0.7515246514272069,
		},
		Point {
			x: 0.4765360753251637,
			y: 0.7098828297064373,
		},
		Point {
			x: 0.4818205885775795,
			y: 0.7166950802177746,
		},
		Point {
			x: 0.4535763859568193,
			y: 0.7066752716942384,
		},
		Point {
			x: 0.4617947577193161,
			y: 0.7174905164612052,
		},
		Point {
			x: 0.4415181452342025,
			y: 0.7804854951076398,
		},
		Point {
			x: 0.4494805891277487,
			y: 0.7530681533898135,
		},
		Point {
			x: 0.4737987436955353,
			y: 0.7269525716189946,
		},
		Point {
			x: 0.4161679063796719,
			y: 0.7201088912843232,
		},
		Point {
			x: 0.4463095166057184,
			y: 0.7266331882118862,
		},
		Point {
			x: 0.4240188132803634,
			y: 0.7716024118699741,
		},
		Point {
			x: 0.4716321574021465,
			y: 0.7528866494926185,
		},
		Point {
			x: 0.4300850828061567,
			y: 0.7636781356966775,
		},
		Point {
			x: 0.4256645645810565,
			y: 0.7556389133078428,
		},
		Point {
			x: 0.4434192596999944,
			y: 0.7095812793729724,
		},
		Point {
			x: 0.4214769867494808,
			y: 0.7440522344884736,
		},
		Point {
			x: 0.473376083273193,
			y: 0.742010090162372,
		},
		Point {
			x: 0.4133059522015202,
			y: 0.7344353835852109,
		},
		Point {
			x: 0.4565749021271298,
			y: 0.7715808361978279,
		},
		Point {
			x: 0.4240972385272187,
			y: 0.7084759469710651,
		},
		Point {
			x: 0.4708095520548324,
			y: 0.724304654598107,
		},
		Point {
			x: 0.4677438938679515,
			y: 0.7738311839969102,
		},
		Point {
			x: 0.4760924923028012,
			y: 0.7741796767768939,
		},
		Point {
			x: 0.4388311176859141,
			y: 0.7053804490340043,
		},
		Point {
			x: 0.4771580872547635,
			y: 0.7123632185295367,
		},
		Point {
			x: 0.4583856447437147,
			y: 0.75376034901863,
		},
		Point {
			x: 0.418053015365026,
			y: 0.7305600743478824,
		},
		Point {
			x: 0.4649817754582818,
			y: 0.7795228130426127,
		},
		Point {
			x: 0.4447840055811841,
			y: 0.7385175299604932,
		},
		Point {
			x: 0.4493469202402394,
			y: 0.7192830840416244,
		},
		Point {
			x: 0.4253048895199373,
			y: 0.7697008018401699,
		},
		Point {
			x: 0.4649569144933393,
			y: 0.7550835797219836,
		},
		Point {
			x: 0.4399511630058145,
			y: 0.7749934016525937,
		},
		Point {
			x: 0.4125963389718685,
			y: 0.7110349628756919,
		},
		Point {
			x: 0.4596589603645559,
			y: 0.720640101686468,
		},
		Point {
			x: 0.4208260711981383,
			y: 0.748702420028351,
		},
		Point {
			x: 0.4251193416216033,
			y: 0.7519344018715135,
		},
		Point {
			x: 0.4434263475217318,
			y: 0.7349283288863684,
		},
		Point {
			x: 0.4156813727560871,
			y: 0.7712068648111479,
		},
		Point {
			x: 0.4309644051062002,
			y: 0.7624033579161289,
		},
		Point {
			x: 0.4249397387623538,
			y: 0.7732492845676858,
		},
		Point {
			x: 0.4279484076832224,
			y: 0.7106832840144266,
		},
		Point {
			x: 0.4671885427580368,
			y: 0.745684749714484,
		},
		Point {
			x: 0.4707659001824547,
			y: 0.7353218163426498,
		},
		Point {
			x: 0.4184829100937939,
			y: 0.7250212171924402,
		},
		Point {
			x: 0.4208665868885436,
			y: 0.7332441194422802,
		},
		Point {
			x: 0.4598565699824425,
			y: 0.7117121166388319,
		},
		Point {
			x: 0.4455282906458267,
			y: 0.779657348836276,
		},
		Point {
			x: 0.4437074945382943,
			y: 0.7795436106841033,
		},
		Point {
			x: 0.4693707599641244,
			y: 0.7574855244192277,
		},
		Point {
			x: 0.4649540155791582,
			y: 0.7715461635014114,
		},
		Point {
			x: 0.4722412420813244,
			y: 0.7577694280366036,
		},
		Point {
			x: 0.4750625520022625,
			y: 0.7729342410313678,
		},
		Point {
			x: 0.4113545606404082,
			y: 0.762994741856378,
		},
		Point {
			x: 0.4439873180039547,
			y: 0.7171029034319846,
		},
		Point {
			x: 0.440623205088162,
			y: 0.7120116902546145,
		},
		Point {
			x: 0.4512639366509529,
			y: 0.7190791882716216,
		},
		Point {
			x: 0.4114538290465722,
			y: 0.7736132836545028,
		},
		Point {
			x: 0.4180664084784322,
			y: 0.7330869085081201,
		},
		Point {
			x: 0.4145743246818689,
			y: 0.7543170889109186,
		},
		Point {
			x: 0.4351927918911267,
			y: 0.7737254043419357,
		},
		Point {
			x: 0.4603687249462487,
			y: 0.756595743080576,
		},
		Point {
			x: 0.483929464883419,
			y: 0.7061498849366041,
		},
		Point {
			x: 0.4327779922062346,
			y: 0.7095973207799543,
		},
		Point {
			x: 0.4208288718113638,
			y: 0.7294820127554917,
		},
		Point {
			x: 0.4524894685229049,
			y: 0.7789359730942482,
		},
		Point {
			x: 0.4228584470246571,
			y: 0.733343459666683,
		},
		Point {
			x: 0.4216127913761086,
			y: 0.7417252705524697,
		},
		Point {
			x: 0.4311445592389343,
			y: 0.2810854468238614,
		},
		Point {
			x: 0.4712938958856154,
			y: 0.2858837341123505,
		},
		Point {
			x: 0.4884061937100282,
			y: 0.2792801627491229,
		},
		Point {
			x: 0.4441119487194393,
			y: 0.2684745732529941,
		},
		Point {
			x: 0.4367391956506695,
			y: 0.2746471548618712,
		},
		Point {
			x: 0.4720254353717128,
			y: 0.2515235410507645,
		},
		Point {
			x: 0.4462213269642754,
			y: 0.3014117210438481,
		},
		Point {
			x: 0.4339318071852852,
			y: 0.2546603353595834,
		},
		Point {
			x: 0.4433140863540932,
			y: 0.2807483875507113,
		},
		Point {
			x: 0.4788297792013663,
			y: 0.2782484817012927,
		},
		Point {
			x: 0.4424248728123169,
			y: 0.2997168501032024,
		},
		Point {
			x: 0.4962438469119371,
			y: 0.2564594700952245,
		},
		Point {
			x: 0.4368498529983884,
			y: 0.2370103660759166,
		},
		Point {
			x: 0.4836009773240084,
			y: 0.2957333259957395,
		},
		Point {
			x: 0.4602712048967121,
			y: 0.2905222627198833,
		},
		Point {
			x: 0.4501039862994763,
			y: 0.2508705549278354,
		},
		Point {
			x: 0.4568262291112461,
			y: 0.2381486893994688,
		},
		Point {
			x: 0.4535577877582683,
			y: 0.2639698020122092,
		},
		Point {
			x: 0.473011943562285,
			y: 0.2947251537893009,
		},
		Point {
			x: 0.4437437393249465,
			y: 0.2842888134139976,
		},
		Point {
			x: 0.4663623003966749,
			y: 0.2546931717390087,
		},
		Point {
			x: 0.4826322771250252,
			y: 0.2490135797527491,
		},
		Point {
			x: 0.4467534716415325,
			y: 0.252996299221929,
		},
		Point {
			x: 0.4285342699113801,
			y: 0.3079766328194913,
		},
		Point {
			x: 0.4719070207217473,
			y: 0.298862824847594,
		},
		Point {
			x: 0.4563427418826612,
			y: 0.2826991867722465,
		},
		Point {
			x: 0.4525497089668795,
			y: 0.264771587115633,
		},
		Point {
			x: 0.428545884011217,
			y: 0.2879913947827592,
		},
		Point {
			x: 0.4405705889929475,
			y: 0.2511657848020462,
		},
		Point {
			x: 0.4603254694797803,
			y: 0.3139098762898325,
		},
		Point {
			x: 0.4229826186792434,
			y: 0.2460719175535844,
		},
		Point {
			x: 0.4866507081986629,
			y: 0.2802909991148467,
		},
		Point {
			x: 0.4218140781055242,
			y: 0.2647096888409038,
		},
		Point {
			x: 0.4433324521439906,
			y: 0.2951901754166651,
		},
		Point {
			x: 0.4328010545485013,
			y: 0.2915474050360138,
		},
		Point {
			x: 0.4768708654536637,
			y: 0.3094003654236859,
		},
		Point {
			x: 0.4779725049146974,
			y: 0.312360498110304,
		},
		Point {
			x: 0.4164929173757856,
			y: 0.2345270435897136,
		},
		Point {
			x: 0.4967988117509256,
			y: 0.3093347214718966,
		},
		Point {
			x: 0.471757421750379,
			y: 0.2695323707248306,
		},
		Point {
			x: 0.4983871134958178,
			y: 0.2583017323485949,
		},
		Point {
			x: 0.4651246780474536,
			y: 0.2384368414313467,
		},
		Point {
			x: 0.4597909059926949,
			y: 0.3002473922171364,
		},
		Point {
			x: 0.4845125316932186,
			y: 0.281695240496134,
		},
		Point {
			x: 0.7786844330797716,
			y: 0.4879496262516563,
		},
		Point {
			x: 0.7479543289273792,
			y: 0.5254089925360168,
		},
		Point {
			x: 0.7539890380607397,
			y: 0.5726553523669302,
		},
		Point {
			x: 0.7473103588692172,
			y: 0.6050466236924511,
		},
		Point {
			x: 0.7202754229703063,
			y: 0.6280165782125324,
		},
		Point {
			x: 0.713452540062542,
			y: 0.6502626568194579,
		},
		Point {
			x: 0.6835628495825435,
			y: 0.7090388214552382,
		},
		Point {
			x: 0.6653153211353998,
			y: 0.7376102176044832,
		},
		Point {
			x: 0.6258207228889747,
			y: 0.737530724257638,
		},
		Point {
			x: 0.6194834674786058,
			y: 0.782010589277707,
		},
		Point {
			x: 0.5892482277791029,
			y: 0.7811979210157731,
		},
		Point {
			x: 0.5426637970217211,
			y: 0.7987796255290556,
		},
		Point {
			x: 0.4944497582036909,
			y: 0.8141052672847844,
		},
		Point {
			x: 0.4904963829719387,
			y: 0.8165619311367189,
		},
		Point {
			x: 0.4383115157079729,
			y: 0.8285035385349864,
		},
		Point {
			x: 0.3774152036286358,
			y: 0.8105307861259383,
		},
		Point {
			x: 0.3664108351656608,
			y: 0.8141392022239933,
		},
		Point {
			x: 0.3105524952486755,
			y: 0.7999362076339251,
		},
		Point {
			x: 0.2908611179041408,
			y: 0.7850721342248099,
		},
		Point {
			x: 0.2632579955073213,
			y: 0.7527159183706328,
		},
		Point {
			x: 0.2141295546916198,
			y: 0.7411648445516051,
		},
		Point {
			x: 0.2086827914605464,
			y: 0.7190311849771891,
		},
		Point {
			x: 0.1802757960769796,
			y: 0.6756798839250456,
		},
		Point {
			x: 0.1591015965989648,
			y: 0.6427304792082399,
		},
		Point {
			x: 0.1460754027333822,
			y: 0.6320396736962564,
		},
		Point {
			x: 0.1230782174633271,
			y: 0.5808924432250178,
		},
		Point {
			x: 0.1173318813062608,
			y: 0.535790988932582,
		},
		Point {
			x: 0.1056732887026217,
			y: 0.510079696226034,
		},
		Point {
			x: 0.132055477374415,
			y: 0.4662163753847897,
		},
		Point {
			x: 0.1215275935573529,
			y: 0.4420422971585965,
		},
		Point {
			x: 0.1322102143975349,
			y: 0.4075833999837861,
		},
		Point {
			x: 0.1370972667290454,
			y: 0.353727525413569,
		},
		Point {
			x: 0.1578012025207495,
			y: 0.3484100935189312,
		},
		Point {
			x: 0.1668439834905578,
			y: 0.3089933742995316,
		},
		Point {
			x: 0.215227562946207,
			y: 0.2741537454521896,
		},
		Point {
			x: 0.2310946854235466,
			y: 0.246019631125543,
		},
		Point {
			x: 0.2614009951733139,
			y: 0.2304417063544322,
		},
		Point {
			x: 0.3161857947995821,
			y: 0.2008803483257373,
		},
		Point {
			x: 0.3331267846553133,
			y: 0.2033147838112808,
		},
		Point {
			x: 0.3531907288798922,
			y: 0.1817033801548397,
		},
		Point {
			x: 0.3926163193817944,
			y: 0.186459947133805,
		},
		Point {
			x: 0.4418747122728561,
			y: 0.1660467668517447,
		},
		Point {
			x: 0.4819302627852148,
			y: 0.1748421103476815,
		},
		Point {
			x: 0.5168445890243976,
			y: 0.1629544087514411,
		},
		Point {
			x: 0.5416396481616,
			y: 0.184549151514834,
		},
		Point {
			x: 0.5766005463332167,
			y: 0.1952036674666759,
		},
		Point {
			x: 0.6092262817717128,
			y: 0.2174392281533351,
		},
		Point {
			x: 0.6509449507712608,
			y: 0.2414025386784042,
		},
		Point {
			x: 0.6723421436290627,
			y: 0.2799584299537139,
		},
		Point {
			x: 0.6724775377289472,
			y: 0.2884550044350425,
		},
		Point {
			x: 0.708094537100445,
			y: 0.3245008000404451,
		},
		Point {
			x: 0.7431193530884015,
			y: 0.3498121720711889,
		},
		Point {
			x: 0.7557306121551426,
			y: 0.3745361840529581,
		},
		Point {
			x: 0.7510081231780292,
			y: 0.416760530942613,
		},
		Point {
			x: 0.7501956015696567,
			y: 0.4619433900130439,
		},
		Point {
			x: 0.7613696061060425,
			y: 0.4926778005176252,
		},
	];
	let cc = autoclust_implementation(&points);
	let mut result: Vec<Res> = vec![];
	for i in points.iter().enumerate() {
		result.push(Res {
			x: i.1.x,
			y: i.1.y,
			label: match cc.find_label_for_index(i.0) {
				Some(x) => x,
				None => 0,
			},
		});
	}
	for v in &result {
		println!("{:?}", v);
	}
}
